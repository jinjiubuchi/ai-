// 文件路径: api/ai.js

import { GoogleGenerativeAI } from '@google/generative-ai';

// 获取 Vercel 环境变量中配置的 API Key
const GEMINI_API_KEY = process.env.GEMINI_API_KEY;

// 初始化 Google Generative AI 客户端
if (!GEMINI_API_KEY) {
    console.error("GEMINI_API_KEY is not set in environment variables.");
}
const ai = GEMINI_API_KEY ? new GoogleGenerativeAI(GEMINI_API_KEY) : null;
const model = "gemini-2.5-flash"; // 选用快速的模型

/**
 * Vercel Serverless Function 主函数
 * @param {object} req - 请求对象
 * @param {object} res - 响应对象
 */
export default async function handler(req, res) {
    // 允许跨域访问，防止前端被 CORS 策略阻挡
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

    // 处理 OPTIONS 预检请求
    if (req.method === 'OPTIONS') {
        res.status(200).end();
        return;
    }

    if (req.method !== 'POST') {
        res.status(405).json({ error: 'Method Not Allowed. Only POST requests are accepted.' });
        return;
    }

    if (!ai) {
        res.status(500).json({ error: 'AI Client Initialization Failed. GEMINI_API_KEY is missing.' });
        return;
    }

    try {
        const { prompt } = req.body;
        
        if (!prompt) {
            res.status(400).json({ error: 'Missing prompt in request body.' });
            return;
        }

        // 调用 Gemini API 进行内容生成
        const response = await ai.getGenerativeModel({ model }).generateContent({
            contents: [{ role: "user", parts: [{ text: prompt }] }],
            config: {
                // 可选配置：设置温度控制创意性
                temperature: 0.7, 
            },
        });

        const aiText = response.text;

        // 返回 AI 的回答给前端
        res.status(200).json({ text: aiText });

    } catch (error) {
        console.error("Gemini API Error:", error);
        res.status(500).json({ error: `AI Processing Error: ${error.message}` });
    }
}
